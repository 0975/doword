<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå®šä¹‰è‹±æ–‡å­—åº“ç³»ç»Ÿï¼ˆæ”¯æŒæ•°å­—/æ ‡ç‚¹+é—´è·ç²¾ç»†åŒ–è°ƒèŠ‚ç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            padding: 50px;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
        }

        /* æ ¸å¿ƒå‚æ•°ï¼šå›ºå®šç¼©æ”¾+åº•çº¿å¯¹é½ï¼ˆç§»é™¤å¼ºåˆ¶æ­£æ–¹å½¢ï¼‰ */
        :root {
            --output-base-height: 40px;  /* è¾“å‡ºåŸºå‡†é«˜åº¦ï¼ˆåº•çº¿å¯¹é½å‚è€ƒï¼‰ */
            --canvas-width: 600px;       /* ç”»å¸ƒå®½åº¦ï¼ˆæ”¾å¤§åˆ°600pxï¼‰ */
            --canvas-height: 250px;      /* ç”»å¸ƒé«˜åº¦å¢å¤§åˆ°250px */
            --scale-ratio: 0.25;         /* å›ºå®šç¼©æ”¾æ¯”ä¾‹ï¼ˆ1/4ï¼‰ */
            --letter-spacing: 2px;       /* é»˜è®¤å…¨å±€å­—é—´è· */
            --custom-item-spacing: 2px;  /* å•ç‹¬å­—æ¯é—´è· */
        }

        /* å­—æ¯/æ•°å­—/æ ‡ç‚¹è¾“å‡ºæ ·å¼ï¼šç»Ÿä¸€åº•çº¿å¯¹é½ï¼ˆéæ­£æ–¹å½¢ï¼‰+ æ”¯æŒå­—é—´è·è°ƒèŠ‚ */
        .letter-img, .number-img, .symbol-img {
            all: unset !important;
            display: inline-block !important;
            height: var(--output-base-height) !important; /* é«˜åº¦å›ºå®šï¼Œå®½åº¦è‡ªé€‚åº” */
            object-fit: contain !important;
            vertical-align: bottom !important; /* æ ¸å¿ƒï¼šä»…åº•çº¿å¯¹é½ */
            margin: 0 !important;
            position: relative !important;
            margin-right: var(--letter-spacing) !important; /* å…¨å±€å­—é—´è·æ§åˆ¶ */
            cursor: pointer; /* å¯é€‰ä¸­ */
            transition: all 0.2s;
            pointer-events: auto;
        }

        /* é€‰ä¸­çŠ¶æ€æ ·å¼ */
        .letter-img.selected, .letter-text.selected,
        .number-img.selected, .number-text.selected,
        .symbol-img.selected, .symbol-text.selected {
            outline: 2px solid #4285F4;
            outline-offset: 2px;
            background: rgba(66, 133, 244, 0.1);
        }

        /* å•ç‹¬é—´è·æ ·å¼ï¼ˆä¼˜å…ˆçº§é«˜äºå…¨å±€ï¼‰ */
        .letter-img.custom-spacing, .letter-text.custom-spacing,
        .number-img.custom-spacing, .number-text.custom-spacing,
        .symbol-img.custom-spacing, .symbol-text.custom-spacing {
            margin-right: var(--custom-item-spacing) !important;
        }

        /* æ–‡å­—æ ·å¼ï¼šå­—æ¯/æ•°å­—/æ ‡ç‚¹ç»Ÿä¸€æ ·å¼ */
        .letter-text, .number-text, .symbol-text {
            display: inline-block !important;
            height: var(--output-base-height) !important;
            line-height: var(--output-base-height) !important;
            text-align: center !important;
            vertical-align: bottom !important;
            font-size: calc(var(--output-base-height) * 0.8) !important;
            margin: 0 !important;
            margin-right: var(--letter-spacing) !important; /* å…¨å±€å­—é—´è·æ§åˆ¶ */
            padding: 0 2px !important;
            cursor: pointer; /* å¯é€‰ä¸­ */
            transition: all 0.2s;
            pointer-events: auto;
        }

        /* è¶…å¤§é¢„è§ˆåŒº */
        .preview-area {
            width: 100%;
            min-height: 250px;
            padding: 25px;
            border: 2px dashed #666;
            border-radius: 8px;
            margin-bottom: 20px;
            background: #f8f9fa;
            line-height: var(--output-base-height) !important;
            font-size: 0; /* æ¶ˆé™¤inline-blocké—´éš™ */
            position: relative;
            user-select: none; /* é˜²æ­¢é»˜è®¤æ–‡æœ¬é€‰æ‹© */
        }

        /* å­—é—´è·è°ƒèŠ‚åŒº */
        .letter-spacing-control {
            width: 100%;
            margin: 15px 0;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 8px;
            border: 1px solid #e8f0fe;
        }
        .letter-spacing-control h4 {
            margin-bottom: 10px;
            color: #4285F4;
            font-size: 16px;
        }
        .spacing-slider-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .spacing-slider {
            flex: 1;
            min-width: 200px;
        }
        .spacing-value {
            min-width: 60px;
            font-weight: bold;
            color: #4285F4;
            font-size: 14px;
        }
        .spacing-tip {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        /* å•ç‹¬é—´è·è°ƒèŠ‚åŒºï¼ˆä»…é€‰ä¸­ä¸¤ä¸ªå­—ç¬¦æ—¶æ˜¾ç¤ºï¼‰ */
        .custom-spacing-control {
            width: 100%;
            margin: 15px 0;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffeeba;
            display: none; /* é»˜è®¤éšè— */
        }
        .custom-spacing-control h4 {
            margin-bottom: 10px;
            color: #856404;
            font-size: 16px;
        }
        .custom-spacing-tip {
            font-size: 12px;
            color: #856404;
            margin-top: 8px;
        }

        /* è¾“å…¥åŒº+å›ºå®šé¢æ¿ */
        .input-panel-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .custom-input {
            width: 100%;
            min-height: 150px;
            padding: 18px !important;
            border: 2px solid #4285F4 !important;
            border-radius: 8px;
            font-size: 16px;
            line-height: var(--output-base-height) !important;
            outline: none;
            resize: vertical;
            background: #f8f9fa !important;
            font-size: 0; /* æ¶ˆé™¤inline-blocké—´éš™ */
            user-select: none; /* é˜²æ­¢é»˜è®¤æ–‡æœ¬é€‰æ‹© */
            pointer-events: auto;
        }

        /* å›ºå®šé¢æ¿ */
        .font-fixed-panel {
            width: 100%;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: block;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        /* å­—ç¬¦æ ¼å­ï¼ˆå­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰ */
        .char-grid {
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        .char-grid.numbers {
            grid-template-columns: repeat(10, 1fr); /* æ•°å­—10ä¸ªï¼Œé€‚é…å¸ƒå±€ */
        }
        .char-grid.symbols {
            grid-template-columns: repeat(10, 1fr); /* æ ‡ç‚¹10ä¸ªä¸€ç»„ */
            margin-bottom: 30px;
        }
        .char-grid.capital, .char-grid.symbols {
            margin-top: 15px;
        }
        .char-item {
            width: 50px;
            height: 50px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.8;
        }
        .char-item:hover {
            border-color: #4285F4;
            background: #e8f0fe;
        }
        .char-item.active {
            border-color: #4285F4;
            background: #e8f0fe;
            opacity: 1;
        }
        .char-item span {
            font-size: 12px;
            margin-bottom: 3px;
            color: #666;
        }
        .char-preview {
            width: 35px;
            height: 35px;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .char-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* æ”¾å¤§ç”»å¸ƒï¼šæ— å¼ºåˆ¶åˆ†åŒºï¼Œä»…ä¿ç•™å‚è€ƒçº¿è¾…åŠ© */
        .canvas-area {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 20px;
            flex-wrap: wrap;
        }
        .canvas-tips {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            min-width: 200px;
        }
        .canvas-tips strong {
            color: #4285F4;
        }
        .canvas-container {
            position: relative;
        }
        #drawCanvas {
            width: var(--canvas-width);    /* ç”»å¸ƒå®½åº¦æ”¾å¤§åˆ°600px */
            height: var(--canvas-height);  /* ç”»å¸ƒé«˜åº¦å¢å¤§åˆ°250px */
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: crosshair;
            touch-action: none;
            background: #fff;
            z-index: 1;
        }
        #tempCanvas {
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 3; 
            pointer-events: none;
            border-radius: 4px;
        }
        /* å‚è€ƒçº¿ï¼šä»…è¾…åŠ©ï¼Œä¸å¼ºåˆ¶åˆ†åŒº */
        .canvas-grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }
        .canvas-grid-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: #4285F4;
            opacity: 0.5;
        }

        /* æŒ‰é’®/æ§åˆ¶æ ·å¼ä¼˜åŒ– */
        .brush-size-control {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .tool-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .eraser-shape-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            background: #4285F4;
            color: white;
            transition: background 0.2s;
        }
        button:hover {
            background: #3367D6;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #bb2d3b;
        }
        button.secondary {
            background: #6c757d;
        }
        button.secondary:hover {
            background: #5a6268;
        }
        button.active-tool {
            background: #218838;
        }
        .version-select {
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 150px;
            font-size: 13px;
        }
        .tip {
            color: #666;
            font-size: 12px;
            margin: 5px 0 10px 0;
        }
        .case-tip {
            font-size: 14px;
            color: #4285F4;
            margin-bottom: 10px;
            font-weight: 500;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .operation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .operation-buttons button {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>è‡ªå®šä¹‰è‹±æ–‡å­—åº“ç³»ç»Ÿï¼ˆæ”¯æŒæ•°å­—/æ ‡ç‚¹+é—´è·ç²¾ç»†åŒ–è°ƒèŠ‚ç‰ˆï¼‰</h1>

    <!-- è¶…å¤§é¢„è§ˆåŒº -->
    <h3>æ•ˆæœé¢„è§ˆåŒºï¼ˆä»…åº•çº¿å¯¹é½ï¼ŒæŒ‰ç»˜ç”»å®½åº¦+æ•´ç”»å¸ƒé«˜åº¦è£å‰ªï¼‰</h3>
    <div class="preview-area" id="previewArea">
        æ’å…¥çš„å­—ç¬¦æŒ‰ã€Œç»˜ç”»å®½åº¦+æ•´ç”»å¸ƒé«˜åº¦ã€è£å‰ªåå›ºå®šæ¯”ä¾‹ç¼©æ”¾ï¼Œä»…åº•çº¿å¯¹é½...
    </div>

    <!-- å…¨å±€å­—é—´è·è°ƒèŠ‚åŒº -->
    <div class="letter-spacing-control">
        <h4>å…¨å±€å­—ç¬¦é—´è·è°ƒèŠ‚</h4>
        <div class="spacing-slider-wrapper">
            <input type="range" min="-50" max="50" value="2" class="spacing-slider" id="letterSpacingSlider">
            <span class="spacing-value" id="letterSpacingValue">2px</span>
        </div>
        <p class="spacing-tip">ğŸ”¹ è´Ÿå€¼ï¼šå­—ç¬¦é‡å  | 0ï¼šæ— é—´è· | æ­£å€¼ï¼šå¢å¤§é—´è· | å½“å‰é»˜è®¤ï¼š2px</p>
    </div>

    <!-- å•ç‹¬é—´è·è°ƒèŠ‚åŒºï¼ˆä»…é€‰ä¸­ä¸¤ä¸ªå­—ç¬¦æ—¶æ˜¾ç¤ºï¼‰ -->
    <div class="custom-spacing-control" id="customSpacingControl">
        <h4>é€‰ä¸­å­—ç¬¦å•ç‹¬é—´è·è°ƒèŠ‚ï¼ˆä»…è°ƒæ•´ä¸¤ä¸ªå­—ç¬¦ä¹‹é—´ï¼‰</h4>
        <div class="spacing-slider-wrapper">
            <input type="range" min="-50" max="50" value="2" class="spacing-slider" id="customSpacingSlider">
            <span class="spacing-value" id="customSpacingValue">2px</span>
        </div>
        <div class="operation-buttons">
            <button onclick="resetCustomSpacing()" class="secondary">é‡ç½®é€‰ä¸­å­—ç¬¦é—´è·</button>
            <button onclick="clearSelection()" class="secondary">å–æ¶ˆé€‰ä¸­</button>
        </div>
        <p class="custom-spacing-tip">ğŸ”¹ ä»…è°ƒæ•´é€‰ä¸­çš„ä¸¤ä¸ªå­—ç¬¦ä¹‹é—´çš„é—´è· | ä¼˜å…ˆçº§é«˜äºå…¨å±€é—´è· | è°ƒæ•´åç«‹å³ç”Ÿæ•ˆ</p>
    </div>

    <!-- è¾“å…¥åŒº+å›ºå®šé¢æ¿ -->
    <h3>è¾“å…¥æµ‹è¯•åŒºï¼ˆæŒ‰é”®ç›˜ç›´æ¥æ’å…¥ï¼Œæœ‰å›¾å‡ºå›¾/æ— å›¾å‡ºå­—ï¼Œæ”¯æŒå­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰</h3>
    <div class="tip">
        âœ¨ ç‚¹å‡»å­—ç¬¦å¯é€‰ä¸­ï¼Œé€‰ä¸­ä¸¤ä¸ªå­—ç¬¦åå¯å•ç‹¬è°ƒèŠ‚é—´è· | 
        å­—ç¬¦æ ¼å­ä»…ç”¨äºè®¾ç½®å­—åº“ï¼ˆç‚¹å‡»ä¸æ’å…¥ï¼‰| 
        è¾“å‡ºæŒ‰ã€Œç»˜ç”»å®½åº¦+æ•´ç”»å¸ƒé«˜åº¦ã€è£å‰ªï¼ˆéæ­£æ–¹å½¢ï¼‰| 
        æ”¯æŒå…¨å±€/å•ç‹¬å­—é—´è·è°ƒèŠ‚ï¼ˆåŒ…æ‹¬é‡å ï¼‰|
        æ”¯æŒï¼šå­—æ¯(a-z/A-Z)ã€æ•°å­—(0-9)ã€å¸¸ç”¨æ ‡ç‚¹(.,!?;:()+-*/=)
    </div>
    <div class="input-panel-wrapper" id="inputPanelWrapper">
        <div 
            contenteditable="true" 
            class="custom-input" 
            id="testInput" 
            placeholder="è¾“å…¥å­—ç¬¦ï¼ˆå­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰è‡ªåŠ¨æ’å…¥ï¼Œç‚¹å‡»å­—ç¬¦å¯é€‰ä¸­è°ƒèŠ‚å•ç‹¬é—´è·..."
        ></div>
        
        <div class="font-fixed-panel" id="fontFixedPanel">
            <select class="version-select" id="versionSelector">
                <option value="åˆå§‹ç‰ˆ">åˆå§‹ç‰ˆ</option>
            </select>
            <button onclick="addVersion()">æ–°å¢ç‰ˆæœ¬</button>
            <button onclick="deleteVersion()" class="danger">åˆ é™¤ç‰ˆæœ¬</button>
            <p class="tip">å½“å‰ç‰ˆæœ¬ï¼šåˆå§‹ç‰ˆ | å­—ç¬¦æ ¼å­ä»…ç”¨äºè®¾ç½®å­—åº“ | æŒ‰é”®ç›˜ç›´æ¥æ’å…¥ | å›ºå®šç¼©æ”¾æ¯”ä¾‹ï¼š1/4</p>

            <div class="case-tip">å°å†™å­—æ¯ï¼ˆa-zï¼‰</div>
            <div class="char-grid" id="lowerLetterGrid"></div>

            <div class="case-tip">å¤§å†™å­—æ¯ï¼ˆA-Zï¼‰</div>
            <div class="char-grid capital" id="capitalLetterGrid"></div>

            <div class="case-tip">æ•°å­—ï¼ˆ0-9ï¼‰</div>
            <div class="char-grid numbers" id="numberGrid"></div>

            <div class="case-tip">å¸¸ç”¨æ ‡ç‚¹ç¬¦å·</div>
            <div class="char-grid symbols" id="symbolGrid"></div>

            <div class="canvas-area">
                <!-- ç²¾å‡†è£å‰ªæç¤º -->
                <div class="canvas-tips">
                    <strong>ç»˜åˆ¶è§„åˆ™ï¼ˆç²¾å‡†è£å‰ªï¼‰</strong><br>
                    ğŸ”¹ ç”»å¸ƒå°ºå¯¸ï¼š600Ã—250pxï¼ˆæ”¾å¤§æ›´æ˜“ç»˜åˆ¶ï¼‰<br>
                    ğŸ”¹ å‚è€ƒçº¿ä»…è¾…åŠ©ï¼Œå¯è‡ªç”±ç»˜åˆ¶å­—ç¬¦<br>
                    ğŸ”¹ åœ†åœˆï¼šæ‹–æ‹½å½¢æˆæ­£æ–¹å½¢èŒƒå›´ç»˜åˆ¶æ­£åœ†<br>
                    ğŸ”¹ ä¿å­˜ï¼šè£å‰ªã€Œç»˜ç”»å®½åº¦ + æ•´ç”»å¸ƒé«˜åº¦ã€åŒºåŸŸ<br>
                    ğŸ”¹ è¾“å‡ºï¼šæŒ‰å›ºå®šæ¯”ä¾‹ï¼ˆ1/4ï¼‰ç¼©æ”¾ï¼Œä»…åº•çº¿å¯¹é½<br>
                    ğŸ”¹ è¾“å‡ºä¸ºéæ­£æ–¹å½¢ï¼Œä¿ç•™åŸå§‹å®½é«˜æ¯”
                </div>
                
                <div>
                    <!-- å·¥å…·é€‰æ‹©åŒº -->
                    <div class="tool-group">
                        <button onclick="setTool('brush')" class="active-tool">ç”»ç¬”</button>
                        <button onclick="setTool('line')">ç›´çº¿</button>
                        <button onclick="setTool('circle')">åœ†åœˆ</button>
                        <button onclick="setBrushColor('black')">é»‘è‰²ç”»ç¬”</button>
                        <button onclick="setBrushColor('white')">æ©¡çš®æ“¦</button>
                    </div>
                    
                    <!-- æ©¡çš®æ“¦å½¢çŠ¶é€‰æ‹©åŒº -->
                    <div class="eraser-shape-group" style="display: none;">
                        <button onclick="setEraserShape('round')" class="active-tool">åœ†å½¢æ©¡çš®æ“¦</button>
                        <button onclick="setEraserShape('square')">æ–¹å½¢æ©¡çš®æ“¦</button>
                    </div>
                    
                    <div class="brush-size-control">
                        <span>å·¥å…·ç²—ç»†:</span>
                        <input type="range" min="1" max="20" value="5" onchange="setBrushSize(this.value)">
                        <span id="brushSizeValue">5</span>
                    </div>
                    
                    <button onclick="clearCanvas()" class="secondary">æ¸…ç©ºç”»å¸ƒ</button>
                    <button onclick="saveCanvasToChar()" class="secondary">ä¿å­˜åˆ°é€‰ä¸­å­—ç¬¦</button>
                    
                    <div class="canvas-container">
                        <!-- ä¸»ç”»å¸ƒç”¨äºä¿å­˜å·²ç»˜åˆ¶å†…å®¹ -->
                        <canvas id="drawCanvas" width="600" height="250"></canvas>
                        <!-- ä¸´æ—¶ç”»å¸ƒç”¨äºé¢„è§ˆå½“å‰ç»˜åˆ¶çš„å›¾å½¢ -->
                        <canvas id="tempCanvas" width="600" height="250"></canvas>
                        <div class="canvas-grid-lines" id="canvasGridLines"></div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button onclick="uploadCharImg()" class="secondary">ä¸Šä¼ å­—ç¬¦å›¾ç‰‡</button>
                <button onclick="resetCharImg()" class="danger">é‡ç½®é€‰ä¸­å­—ç¬¦</button>
                <button onclick="exportFontLibrary()" class="secondary">å¯¼å‡ºå­—åº“</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        // æ‰©å±•å­—åº“ï¼šåŒ…å«å­—æ¯ã€æ•°å­—ã€å¸¸ç”¨æ ‡ç‚¹
        const ALL_CHARS = {
            letters: {
                lower: 'abcdefghijklmnopqrstuvwxyz'.split(''),
                capital: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('')
            },
            numbers: '0123456789'.split(''),
            symbols: ['.', ',', '!', '?', ';', ':', '(', ')', '+', '-', '*', '/', '='] // å¸¸ç”¨æ ‡ç‚¹
        };

        // åˆå§‹åŒ–å­—åº“ï¼ˆåŒ…å«æ‰€æœ‰å­—ç¬¦ï¼‰
        let fontLibrary = JSON.parse(localStorage.getItem('fontLibrary')) || {
            "åˆå§‹ç‰ˆ": Object.fromEntries([
                ...ALL_CHARS.letters.lower,
                ...ALL_CHARS.letters.capital,
                ...ALL_CHARS.numbers,
                ...ALL_CHARS.symbols
            ].map(char => [char, '']))
        };

        let currentVersion = "åˆå§‹ç‰ˆ";
        let selectedChar = "a"; // é€‰ä¸­çš„å­—ç¬¦ï¼ˆç”¨äºè®¾ç½®å­—åº“ï¼‰
        let brushColor = "black";
        let brushSize = 5;
        let currentTool = "brush"; // å½“å‰å·¥å…·ï¼Œé»˜è®¤ç”»ç¬”
        let eraserShape = "round"; // æ©¡çš®æ“¦å½¢çŠ¶ï¼Œé»˜è®¤åœ†å½¢
        let letterSpacing = 2; // é»˜è®¤å…¨å±€å­—é—´è·
        let customSpacing = 2; // é€‰ä¸­å­—ç¬¦å•ç‹¬é—´è·
        let selectedElements = []; // é€‰ä¸­çš„å­—ç¬¦å…ƒç´ ï¼ˆæœ€å¤š2ä¸ªï¼‰
        let startPoint = null; // ç”¨äºè®°å½•èµ·ç‚¹
        let endPoint = null; // ç”¨äºè®°å½•ç»ˆç‚¹

        // æ ¸å¿ƒè§„åˆ™ï¼šã€Œç»˜ç”»å®½åº¦+æ•´ç”»å¸ƒé«˜åº¦ã€è£å‰ª + å›ºå®šæ¯”ä¾‹ç¼©æ”¾ + ä»…åº•çº¿å¯¹é½
        const RULES = {
            canvas: {
                width: 600,
                height: 250,
                lines: [83, 166] // å‚è€ƒçº¿è°ƒæ•´ä¸ºé€‚åˆ250pxé«˜åº¦
            },
            output: {
                baseHeight: 40,      // è¾“å‡ºåŸºå‡†é«˜åº¦ï¼ˆå›ºå®šï¼‰
                scaleRatio: 0.25,    // å›ºå®šç¼©æ”¾æ¯”ä¾‹ï¼ˆ1/4ï¼‰
                alignBase: 'bottom'   // ä»…åº•çº¿å¯¹é½
            }
        };

        // ç”»å¸ƒåˆå§‹åŒ–
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const tempCanvas = document.getElementById('tempCanvas');
        const tempCtx = tempCanvas.getContext('2d');
        let isDrawing = false;

        // DOMå…ƒç´ 
        const testInput = document.getElementById('testInput');
        const previewArea = document.getElementById('previewArea');
        const canvasGridLines = document.getElementById('canvasGridLines');
        const toolButtons = document.querySelectorAll('.tool-group button');
        const eraserButtons = document.querySelectorAll('.eraser-shape-group button');
        const letterSpacingSlider = document.getElementById('letterSpacingSlider');
        const letterSpacingValue = document.getElementById('letterSpacingValue');
        const customSpacingControl = document.getElementById('customSpacingControl');
        const customSpacingSlider = document.getElementById('customSpacingSlider');
        const customSpacingValue = document.getElementById('customSpacingValue');

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.onload = function() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            tempCtx.lineCap = 'round';
            tempCtx.lineJoin = 'round';
            
            initCanvasGridLines(); // ç»˜åˆ¶å‚è€ƒçº¿
            initCanvasDrawing();    // åˆå§‹åŒ–ç”»å¸ƒç»˜åˆ¶
            initCharGrids();        // åˆå§‹åŒ–å­—ç¬¦æ ¼å­ï¼ˆå­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰
            initVersionSelector();  // åˆå§‹åŒ–ç‰ˆæœ¬é€‰æ‹©
            initKeyboardHandler();  // åˆå§‹åŒ–é”®ç›˜è¾“å…¥ï¼ˆæ”¯æŒæ•°å­—/æ ‡ç‚¹ï¼‰
            initLetterSpacingControl(); // åˆå§‹åŒ–å…¨å±€å­—é—´è·æ§åˆ¶
            initCustomSpacingControl(); // åˆå§‹åŒ–å•ç‹¬é—´è·æ§åˆ¶
            initCharSelection(); // åˆå§‹åŒ–å­—ç¬¦é€‰æ‹©åŠŸèƒ½
            syncPreview();          // åŒæ­¥é¢„è§ˆ
        };

        // ==================== æ–°å¢ï¼šå­—ç¬¦é€‰æ‹©å’Œé—´è·é€»è¾‘ï¼ˆå…¼å®¹æ‰€æœ‰å­—ç¬¦ï¼‰ ====================
        function initCharSelection() {
            // é˜»æ­¢contenteditableåŒºåŸŸçš„é»˜è®¤ç‚¹å‡»è¡Œä¸ºï¼ˆé˜²æ­¢å…‰æ ‡å¹²æ‰°ï¼‰
            testInput.addEventListener('click', function(e) {
                if (!e.target.classList.contains('letter-img') && !e.target.classList.contains('letter-text') &&
                    !e.target.classList.contains('number-img') && !e.target.classList.contains('number-text') &&
                    !e.target.classList.contains('symbol-img') && !e.target.classList.contains('symbol-text')) {
                    return;
                }
                e.preventDefault();
                e.stopPropagation();
            });

            // ç›‘å¬è¾“å…¥åŒºå­—ç¬¦ç‚¹å‡»
            testInput.addEventListener('mousedown', handleCharClick);
            // ç›‘å¬é¢„è§ˆåŒºå­—ç¬¦ç‚¹å‡»ï¼ˆä»…é¢„è§ˆï¼Œä¸ä¿®æ”¹ï¼‰
            previewArea.addEventListener('mousedown', function(e) {
                e.preventDefault();
                handleCharClick(e);
            });
            
            // ç‚¹å‡»ç©ºç™½å¤„å–æ¶ˆé€‰æ‹©
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-input') && !e.target.closest('.preview-area')) {
                    clearSelection();
                }
            });
        }

        // å¤„ç†å­—ç¬¦ç‚¹å‡»é€‰æ‹© - æ”¯æŒæ‰€æœ‰å­—ç¬¦ç±»å‹
        function handleCharClick(e) {
            const target = e.target;
            // å¤„ç†æ‰€æœ‰å­—ç¬¦ç±»å‹
            const isCharElement = target.classList.contains('letter-img') || target.classList.contains('letter-text') ||
                                 target.classList.contains('number-img') || target.classList.contains('number-text') ||
                                 target.classList.contains('symbol-img') || target.classList.contains('symbol-text');
            
            if (isCharElement) {
                e.preventDefault();
                e.stopPropagation();
                
                // é¢„è§ˆåŒºç‚¹å‡»ä»…åŒæ­¥é€‰ä¸­çŠ¶æ€ï¼Œä¸ä¿®æ”¹
                const isPreview = target.closest('.preview-area') !== null;
                const realTarget = isPreview ? 
                    getCorrespondingInputElement(target) : target;
                
                if (!realTarget) return;
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯å·²é€‰ä¸­çš„å…ƒç´ ï¼Œå–æ¶ˆé€‰ä¸­
                if (realTarget.classList.contains('selected')) {
                    realTarget.classList.remove('selected');
                    selectedElements = selectedElements.filter(el => el !== realTarget);
                } else {
                    // æœ€å¤šé€‰ä¸­2ä¸ªå…ƒç´ ï¼Œè¶…è¿‡åˆ™æ¸…ç©º
                    if (selectedElements.length >= 2) {
                        clearSelection();
                    }
                    // æ·»åŠ é€‰ä¸­çŠ¶æ€
                    realTarget.classList.add('selected');
                    selectedElements.push(realTarget);
                }
                
                // åŒæ­¥é¢„è§ˆåŒºé€‰ä¸­çŠ¶æ€
                syncSelectionToPreview();
                // æ›´æ–°å•ç‹¬é—´è·æ§åˆ¶åŒºæ˜¾ç¤º
                updateCustomSpacingUI();
            }
        }

        // è·å–é¢„è§ˆåŒºå…ƒç´ å¯¹åº”çš„è¾“å…¥åŒºå…ƒç´ 
        function getCorrespondingInputElement(previewEl) {
            const previewElements = Array.from(previewArea.querySelectorAll('.letter-img, .letter-text, .number-img, .number-text, .symbol-img, .symbol-text'));
            const inputElements = Array.from(testInput.querySelectorAll('.letter-img, .letter-text, .number-img, .number-text, .symbol-img, .symbol-text'));
            const index = previewElements.indexOf(previewEl);
            
            return index >= 0 && index < inputElements.length ? inputElements[index] : null;
        }

        // åŒæ­¥é€‰ä¸­çŠ¶æ€åˆ°é¢„è§ˆåŒº
        function syncSelectionToPreview() {
            // æ¸…ç©ºé¢„è§ˆåŒºæ‰€æœ‰é€‰ä¸­çŠ¶æ€
            previewArea.querySelectorAll('.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // è·å–è¾“å…¥åŒºæ‰€æœ‰å­—ç¬¦å…ƒç´ 
            const inputElements = Array.from(testInput.querySelectorAll('.letter-img, .letter-text, .number-img, .number-text, .symbol-img, .symbol-text'));
            // è·å–é¢„è§ˆåŒºæ‰€æœ‰å­—ç¬¦å…ƒç´ 
            const previewElements = Array.from(previewArea.querySelectorAll('.letter-img, .letter-text, .number-img, .number-text, .symbol-img, .symbol-text'));
            
            // åŒæ­¥é€‰ä¸­çŠ¶æ€
            selectedElements.forEach(selectedEl => {
                const index = inputElements.indexOf(selectedEl);
                if (index >= 0 && index < previewElements.length) {
                    previewElements[index].classList.add('selected');
                }
            });
        }

        // æ›´æ–°å•ç‹¬é—´è·UIæ˜¾ç¤º
        function updateCustomSpacingUI() {
            if (selectedElements.length === 2) {
                // æ˜¾ç¤ºå•ç‹¬é—´è·è°ƒèŠ‚åŒº
                customSpacingControl.style.display = 'block';
                
                // æŒ‰DOMé¡ºåºæ’åºé€‰ä¸­çš„å…ƒç´ 
                const sortedElements = sortElementsByPosition(selectedElements);
                const firstEl = sortedElements[0];
                
                // è·å–å½“å‰é—´è·å€¼
                const currentMarginRight = parseInt(firstEl.style.marginRight) || 
                                          parseInt(getComputedStyle(firstEl).marginRight) || 
                                          letterSpacing;
                
                // è®¾ç½®æ»‘å—å€¼
                customSpacing = currentMarginRight;
                customSpacingSlider.value = currentMarginRight;
                customSpacingValue.textContent = `${currentMarginRight}px`;
                
                // æ›´æ–°CSSå˜é‡
                document.documentElement.style.setProperty('--custom-item-spacing', `${currentMarginRight}px`);
                
                // å®æ—¶æ›´æ–°é—´è·
                updateCustomSpacing();
            } else {
                // éšè—å•ç‹¬é—´è·è°ƒèŠ‚åŒº
                customSpacingControl.style.display = 'none';
            }
        }

        // æŒ‰DOMä½ç½®æ’åºå…ƒç´ 
        function sortElementsByPosition(elements) {
            return [...elements].sort((a, b) => {
                const rectA = a.getBoundingClientRect();
                const rectB = b.getBoundingClientRect();
                return rectA.left - rectB.left || rectA.top - rectB.top;
            });
        }

        // åˆå§‹åŒ–å…¨å±€å­—é—´è·æ§åˆ¶
        function initLetterSpacingControl() {
            letterSpacingSlider.value = letterSpacing;
            letterSpacingValue.textContent = `${letterSpacing}px`;
            
            // ç›‘å¬æ»‘å—å˜åŒ–
            letterSpacingSlider.addEventListener('input', function() {
                letterSpacing = parseInt(this.value);
                letterSpacingValue.textContent = `${letterSpacing}px`;
                
                // æ›´æ–°CSSå˜é‡ï¼ˆå…¨å±€ï¼‰
                document.documentElement.style.setProperty('--letter-spacing', `${letterSpacing}px`);
                
                // åªæ›´æ–°æœªè®¾ç½®å•ç‹¬é—´è·çš„å­—ç¬¦
                updateNonCustomSpacingChars();
                
                // åŒæ­¥æ›´æ–°é¢„è§ˆ
                syncPreview();
            });
            
            // åˆå§‹åŒ–CSSå˜é‡
            document.documentElement.style.setProperty('--letter-spacing', `${letterSpacing}px`);
        }

        // åˆå§‹åŒ–å•ç‹¬é—´è·æ§åˆ¶
        function initCustomSpacingControl() {
            customSpacingSlider.value = customSpacing;
            customSpacingValue.textContent = `${customSpacing}px`;
            
            // ç›‘å¬æ»‘å—å˜åŒ– - å®æ—¶ç”Ÿæ•ˆ
            customSpacingSlider.addEventListener('input', function() {
                customSpacing = parseInt(this.value);
                customSpacingValue.textContent = `${customSpacing}px`;
                
                // æ›´æ–°CSSå˜é‡
                document.documentElement.style.setProperty('--custom-item-spacing', `${customSpacing}px`);
                
                // ç«‹å³æ›´æ–°é€‰ä¸­å­—ç¬¦çš„é—´è·
                updateCustomSpacing();
                
                // åŒæ­¥é¢„è§ˆ
                syncPreview();
            });
        }

        // æ›´æ–°é€‰ä¸­å­—ç¬¦çš„å•ç‹¬é—´è·
        function updateCustomSpacing() {
            if (selectedElements.length === 2) {
                // æŒ‰ä½ç½®æ’åº
                const sortedElements = sortElementsByPosition(selectedElements);
                const firstEl = sortedElements[0];
                const secondEl = sortedElements[1];
                
                // ç»™ç¬¬ä¸€ä¸ªå…ƒç´ æ·»åŠ è‡ªå®šä¹‰é—´è·æ ‡è®°å¹¶è®¾ç½®é—´è·
                firstEl.classList.add('custom-spacing');
                firstEl.style.marginRight = `${customSpacing}px`;
                
                // ç¡®ä¿ç¬¬äºŒä¸ªå…ƒç´ æ²¡æœ‰è‡ªå®šä¹‰é—´è·
                if (secondEl.classList.contains('custom-spacing') && 
                    selectedElements.indexOf(secondEl) === 1) {
                    secondEl.classList.remove('custom-spacing');
                    secondEl.style.marginRight = '';
                }
            }
        }

        // æ›´æ–°æœªè®¾ç½®å•ç‹¬é—´è·çš„å­—ç¬¦
        function updateNonCustomSpacingChars() {
            // è¾“å…¥åŒºæ‰€æœ‰å­—ç¬¦ç±»å‹
            const inputChars = testInput.querySelectorAll('.letter-img, .letter-text, .number-img, .number-text, .symbol-img, .symbol-text');
            inputChars.forEach(char => {
                if (!char.classList.contains('custom-spacing')) {
                    char.style.marginRight = `${letterSpacing}px`;
                }
            });
            
            // é¢„è§ˆåŒºæ‰€æœ‰å­—ç¬¦ç±»å‹
            const previewChars = previewArea.querySelectorAll('.letter-img, .letter-text, .number-img, .number-text, .symbol-img, .symbol-text');
            previewChars.forEach(char => {
                if (!char.classList.contains('custom-spacing')) {
                    char.style.marginRight = `${letterSpacing}px`;
                }
            });
        }

        // é‡ç½®é€‰ä¸­å­—ç¬¦çš„å•ç‹¬é—´è·
        function resetCustomSpacing() {
            if (selectedElements.length > 0) {
                selectedElements.forEach(char => {
                    char.style.marginRight = `${letterSpacing}px`;
                    char.classList.remove('custom-spacing');
                });
                
                // é‡ç½®æ»‘å—å€¼ä¸ºå…¨å±€é—´è·
                customSpacing = letterSpacing;
                customSpacingSlider.value = letterSpacing;
                customSpacingValue.textContent = `${letterSpacing}px`;
                
                // æ›´æ–°CSSå˜é‡
                document.documentElement.style.setProperty('--custom-item-spacing', `${letterSpacing}px`);
                
                syncPreview();
            }
        }

        // æ¸…ç©ºé€‰ä¸­çŠ¶æ€
        function clearSelection() {
            // ç§»é™¤è¾“å…¥åŒºé€‰ä¸­æ ·å¼
            selectedElements.forEach(el => {
                el.classList.remove('selected');
            });
            
            // ç§»é™¤é¢„è§ˆåŒºé€‰ä¸­æ ·å¼
            previewArea.querySelectorAll('.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // æ¸…ç©ºé€‰ä¸­æ•°ç»„
            selectedElements = [];
            
            // éšè—å•ç‹¬é—´è·è°ƒèŠ‚åŒº
            customSpacingControl.style.display = 'none';
        }

        // ==================== æ–°å¢ï¼šå­—ç¬¦æ ¼å­åˆå§‹åŒ–ï¼ˆå­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰ ====================
        function initCharGrids() {
            // æ¸²æŸ“å°å†™å­—æ¯
            const lowerGrid = document.getElementById('lowerLetterGrid');
            lowerGrid.innerHTML = '';
            ALL_CHARS.letters.lower.forEach(char => {
                renderCharItem(lowerGrid, char, 'letter');
            });
            
            // æ¸²æŸ“å¤§å†™å­—æ¯
            const capitalGrid = document.getElementById('capitalLetterGrid');
            capitalGrid.innerHTML = '';
            ALL_CHARS.letters.capital.forEach(char => {
                renderCharItem(capitalGrid, char, 'letter');
            });
            
            // æ¸²æŸ“æ•°å­—
            const numberGrid = document.getElementById('numberGrid');
            numberGrid.innerHTML = '';
            ALL_CHARS.numbers.forEach(char => {
                renderCharItem(numberGrid, char, 'number');
            });
            
            // æ¸²æŸ“æ ‡ç‚¹ç¬¦å·
            const symbolGrid = document.getElementById('symbolGrid');
            symbolGrid.innerHTML = '';
            ALL_CHARS.symbols.forEach(char => {
                renderCharItem(symbolGrid, char, 'symbol');
            });
        }

        // æ¸²æŸ“å•ä¸ªå­—ç¬¦æ ¼å­ï¼ˆæ”¯æŒå­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰
        function renderCharItem(container, char, type) {
            const item = document.createElement('div');
            item.className = `char-item ${char === selectedChar ? 'active' : ''}`;
            item.innerHTML = `
                <span>${char}</span>
                <div class="char-preview" id="preview-${escapeCharId(char)}">
                    ${fontLibrary[currentVersion][char] ? 
                        `<img src="${fontLibrary[currentVersion][char]}" alt="${char}">` : 'ç©º'}
                </div>
            `;
            // ä»…é€‰ä¸­å­—ç¬¦ï¼ˆç”¨äºè®¾ç½®å­—åº“ï¼‰
            item.onclick = (e) => {
                e.stopPropagation();
                selectedChar = char;
                document.querySelectorAll('.char-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            };
            container.appendChild(item);
        }

        // è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦IDï¼ˆé¿å…DOM IDå†²çªï¼‰
        function escapeCharId(char) {
            const escapeMap = {
                '.': 'dot', ',': 'comma', '!': 'excl', '?': 'quest', 
                ';': 'semicolon', ':': 'colon', '(': 'lparen', ')': 'rparen',
                '+': 'plus', '-': 'minus', '*': 'asterisk', '/': 'slash', '=': 'equal'
            };
            return escapeMap[char] || char;
        }

        // ==================== ç”»å¸ƒç»˜åˆ¶é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰ ====================
        function initCanvasGridLines() {
            canvasGridLines.innerHTML = '';
            RULES.canvas.lines.forEach(y => {
                const line = document.createElement('div');
                line.className = 'canvas-grid-line';
                line.style.top = `${y}px`;
                canvasGridLines.appendChild(line);
            });
        }

        function initCanvasDrawing() {
            // é¼ æ ‡äº‹ä»¶
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', cancelDrawing);
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆé€‚é…ç§»åŠ¨ç«¯ï¼‰
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                startDrawing({clientX: touch.clientX, clientY: touch.clientY});
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                draw({clientX: touch.clientX, clientY: touch.clientY});
            });
            canvas.addEventListener('touchend', stopDrawing);
        }

        function setTool(tool) {
            if (brushColor !== 'white') {
                currentTool = tool;
                toolButtons.forEach(btn => {
                    btn.classList.remove('active-tool');
                    if (btn.onclick.toString().includes(`setTool('${tool}')`)) {
                        btn.classList.add('active-tool');
                    }
                });
            }
        }

        function setEraserShape(shape) {
            eraserShape = shape;
            eraserButtons.forEach(btn => {
                btn.classList.remove('active-tool');
                if (btn.onclick.toString().includes(`setEraserShape('${shape}')`)) {
                    btn.classList.add('active-tool');
                }
            });
            
            ctx.lineCap = shape === 'round' ? 'round' : 'butt';
            ctx.lineJoin = shape === 'round' ? 'round' : 'miter';
            tempCtx.lineCap = shape === 'round' ? 'round' : 'butt';
            tempCtx.lineJoin = shape === 'round' ? 'round' : 'miter';
        }

        function getCanvasPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function getCircleParams(start, end) {
            const centerX = (start.x + end.x) / 2;
            const centerY = (start.y + end.y) / 2;
            const width = Math.abs(end.x - start.x);
            const height = Math.abs(end.y - start.y);
            const sideLength = Math.min(width, height);
            const radius = sideLength / 2;
            
            return { centerX, centerY, radius };
        }

        function startDrawing(e) {
            isDrawing = true;
            startPoint = getCanvasPos(e);
            endPoint = {...startPoint};
            
            if (brushColor === 'white') {
                ctx.beginPath();
                ctx.moveTo(startPoint.x, startPoint.y);
                ctx.strokeStyle = brushColor;
                ctx.lineWidth = brushSize;
            } else if (currentTool === 'brush') {
                ctx.beginPath();
                ctx.moveTo(startPoint.x, startPoint.y);
                ctx.strokeStyle = brushColor;
                ctx.lineWidth = brushSize;
            }
            
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
        }

        function draw(e) {
            if (!isDrawing || !startPoint) return;
            
            endPoint = getCanvasPos(e);
            
            if (brushColor === 'white') {
                ctx.lineTo(endPoint.x, endPoint.y);
                ctx.stroke();
            } else if (currentTool === 'brush') {
                ctx.lineTo(endPoint.x, endPoint.y);
                ctx.stroke();
            } else {
                tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.strokeStyle = brushColor;
                tempCtx.lineWidth = brushSize;
                
                tempCtx.beginPath();
                if (currentTool === 'line') {
                    tempCtx.moveTo(startPoint.x, startPoint.y);
                    tempCtx.lineTo(endPoint.x, endPoint.y);
                } else if (currentTool === 'circle') {
                    const { centerX, centerY, radius } = getCircleParams(startPoint, endPoint);
                    tempCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    
                    // è¾…åŠ©æ­£æ–¹å½¢
                    tempCtx.setLineDash([2, 2]);
                    tempCtx.strokeStyle = '#999';
                    tempCtx.lineWidth = 1;
                    const halfSide = radius;
                    tempCtx.rect(
                        centerX - halfSide, 
                        centerY - halfSide, 
                        halfSide * 2, 
                        halfSide * 2
                    );
                    tempCtx.stroke();
                    tempCtx.setLineDash([]);
                    tempCtx.strokeStyle = brushColor;
                    tempCtx.lineWidth = brushSize;
                }
                tempCtx.stroke();
            }
        }

        function stopDrawing() {
            if (!isDrawing || !startPoint || !endPoint) {
                cancelDrawing();
                return;
            }
            
            if (brushColor !== 'white' && 
                (startPoint.x !== endPoint.x || startPoint.y !== endPoint.y)) {
                
                if (currentTool === 'line') {
                    ctx.strokeStyle = brushColor;
                    ctx.lineWidth = brushSize;
                    ctx.beginPath();
                    ctx.moveTo(startPoint.x, startPoint.y);
                    ctx.lineTo(endPoint.x, endPoint.y);
                    ctx.stroke();
                    
                } else if (currentTool === 'circle') {
                    const { centerX, centerY, radius } = getCircleParams(startPoint, endPoint);
                    
                    if (radius > 0) {
                        ctx.strokeStyle = brushColor;
                        ctx.lineWidth = brushSize;
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                }
            }
            
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            isDrawing = false;
            startPoint = null;
            endPoint = null;
        }

        function cancelDrawing() {
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            isDrawing = false;
            startPoint = null;
            endPoint = null;
        }

        // ==================== ç‰ˆæœ¬ç®¡ç†ï¼ˆå…¼å®¹æ‰€æœ‰å­—ç¬¦ï¼‰ ====================
        function initVersionSelector() {
            const selector = document.getElementById('versionSelector');
            selector.innerHTML = Object.keys(fontLibrary).map(v => 
                `<option value="${v}">${v}</option>`
            ).join('');
            
            selector.onchange = function() {
                currentVersion = this.value;
                initCharGrids();
                document.querySelector('.tip').textContent = 
                    `å½“å‰ç‰ˆæœ¬ï¼š${currentVersion} | å­—ç¬¦æ ¼å­ä»…ç”¨äºè®¾ç½®å­—åº“ | æŒ‰é”®ç›˜ç›´æ¥æ’å…¥ | å›ºå®šç¼©æ”¾æ¯”ä¾‹ï¼š1/4`;
            };
        }

        // ==================== æ–°å¢ï¼šé”®ç›˜è¾“å…¥æ”¯æŒæ•°å­—/æ ‡ç‚¹ ====================
        function initKeyboardHandler() {
            testInput.addEventListener('input', function(e) {
                // è¿‡æ»¤éæ³•å­—ç¬¦ï¼ˆåªä¿ç•™å­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰
                const allowedChars = [...ALL_CHARS.letters.lower, ...ALL_CHARS.letters.capital, ...ALL_CHARS.numbers, ...ALL_CHARS.symbols].join('');
                const cleanHTML = this.innerHTML.replace(new RegExp(`[^${allowedChars}<img>]`, 'g'), '');
                if (this.innerHTML !== cleanHTML) {
                    this.innerHTML = cleanHTML;
                }
                syncPreview();
            });

            // æ ¸å¿ƒè¾“å…¥é€»è¾‘ï¼šæ”¯æŒå­—æ¯/æ•°å­—/æ ‡ç‚¹
            testInput.addEventListener('keydown', (e) => {
                const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Escape'];
                if ((e.ctrlKey || e.metaKey) || allowedKeys.includes(e.key)) {
                    return;
                }

                // å…è®¸çš„å­—ç¬¦ï¼šå­—æ¯ã€æ•°å­—ã€å¸¸ç”¨æ ‡ç‚¹
                const allowedChars = [...ALL_CHARS.letters.lower, ...ALL_CHARS.letters.capital, ...ALL_CHARS.numbers, ...ALL_CHARS.symbols];
                if (allowedChars.includes(e.key)) {
                    e.preventDefault();
                    insertCharToInput(e.key); // æ’å…¥å­—ç¬¦
                }
                // éå…è®¸å­—ç¬¦æç¤º
                else if (e.key.length === 1 && !e.key.match(/\s/)) {
                    setTimeout(() => alert(`ä»…æ”¯æŒè¾“å…¥ï¼šå­—æ¯(a-z/A-Z)ã€æ•°å­—(0-9)ã€å¸¸ç”¨æ ‡ç‚¹(${ALL_CHARS.symbols.join('')})`), 100);
                }
            });
        }

        // æ–°å¢ï¼šæ’å…¥å­—ç¬¦ï¼ˆæ”¯æŒå­—æ¯/æ•°å­—/æ ‡ç‚¹ï¼‰
        function insertCharToInput(char) {
            testInput.focus();

            // è·å–å…‰æ ‡ä½ç½®
            const selection = window.getSelection();
            let range;
            if (selection.rangeCount > 0) {
                range = selection.getRangeAt(0);
                range.deleteContents();
            } else {
                range = document.createRange();
                range.selectNodeContents(testInput);
                range.collapse(false);
                selection.addRange(range);
            }

            const imgSrc = fontLibrary[currentVersion][char];
            let charType = 'letter'; // é»˜è®¤å­—æ¯
            
            // åˆ¤æ–­å­—ç¬¦ç±»å‹
            if (ALL_CHARS.numbers.includes(char)) {
                charType = 'number';
            } else if (ALL_CHARS.symbols.includes(char)) {
                charType = 'symbol';
            }

            if (imgSrc) {
                // æœ‰å­—åº“å›¾ï¼šæŒ‰ç±»å‹åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                const img = document.createElement('img');
                img.src = imgSrc;
                img.className = `${charType}-img`;
                img.alt = char;
                
                // å›ºå®šæ¯”ä¾‹ç¼©æ”¾ + åº•çº¿å¯¹é½
                img.style.height = `${RULES.output.baseHeight}px`;
                img.style.width = 'auto';
                img.style.transformOrigin = RULES.output.alignBase + ' center';
                img.style.transform = `scale(${RULES.output.scaleRatio})`;
                img.style.marginRight = `${letterSpacing}px`;
                
                // æ’å…¥
                range.insertNode(img);
                range.setStartAfter(img);
                selection.removeAllRanges();
                selection.addRange(range);
            } else {
                // æ— å­—åº“å›¾ï¼šæŒ‰ç±»å‹åˆ›å»ºæ–‡å­—å…ƒç´ 
                const span = document.createElement('span');
                span.textContent = char;
                span.className = `${charType}-text`;
                span.style.height = `${RULES.output.baseHeight}px`;
                span.style.lineHeight = `${RULES.output.baseHeight}px`;
                span.style.textAlign = 'center';
                span.style.verticalAlign = RULES.output.alignBase;
                span.style.fontSize = `${RULES.output.baseHeight * 0.8}px`;
                span.style.width = 'auto';
                span.style.padding = '0 2px';
                span.style.marginRight = `${letterSpacing}px`;
                
                range.insertNode(span);
                range.setStartAfter(span);
                selection.removeAllRanges();
                selection.addRange(range);
            }

            syncPreview(); // åŒæ­¥é¢„è§ˆ
        }

        // ==================== ä¿å­˜/ä¸Šä¼ /é‡ç½®å­—ç¬¦ï¼ˆå…¼å®¹æ‰€æœ‰ç±»å‹ï¼‰ ====================
        function saveCanvasToChar() {
            // è·å–ç”»å¸ƒå®Œæ•´åƒç´ æ•°æ®
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;

            // è®¡ç®—ç»˜ç”»å†…å®¹çš„æ°´å¹³è¾¹ç•Œ
            let minX = canvasWidth, maxX = 0;
            let hasContent = false;

            // éå†åƒç´ 
            for (let y = 0; y < canvasHeight; y += 2) {
                for (let x = 0; x < canvasWidth; x += 2) {
                    const index = (y * canvasWidth + x) * 4;
                    if (data[index + 3] > 0) {
                        hasContent = true;
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                    }
                }
            }

            if (!hasContent) {
                alert('ç”»å¸ƒä¸ºç©ºï¼Œè¯·å…ˆç»˜åˆ¶å†…å®¹ï¼');
                return;
            }

            // æ‰©å±•æ°´å¹³è¾¹ç•Œ
            minX = Math.max(0, minX - 2);
            maxX = Math.min(canvasWidth - 1, maxX + 2);

            // è£å‰ªåŒºåŸŸ
            const cropWidth = maxX - minX + 1;
            const cropHeight = canvasHeight;
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = cropWidth;
            cropCanvas.height = cropHeight;
            const cropCtx = cropCanvas.getContext('2d');

            // ç»˜åˆ¶è£å‰ªåçš„å†…å®¹
            cropCtx.putImageData(
                ctx.getImageData(minX, 0, cropWidth, cropHeight),
                0, 0
            );

            // ä¿å­˜è£å‰ªåçš„å›¾ç‰‡
            const dataUrl = cropCanvas.toDataURL('image/png');
            fontLibrary[currentVersion][selectedChar] = dataUrl;
            localStorage.setItem('fontLibrary', JSON.stringify(fontLibrary));
            
            // æ›´æ–°é¢„è§ˆ
            document.getElementById(`preview-${escapeCharId(selectedChar)}`).innerHTML = 
                `<img src="${dataUrl}" alt="${selectedChar}">`;
            
            alert(`å­—ç¬¦${selectedChar}å·²ä¿å­˜ï¼è£å‰ªè§„åˆ™ï¼šç»˜ç”»å®½åº¦ï¼ˆ${cropWidth}pxï¼‰ + æ•´ç”»å¸ƒé«˜åº¦ï¼ˆ${cropHeight}pxï¼‰`);
            clearCanvas();
        }

        function uploadCharImg() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    fontLibrary[currentVersion][selectedChar] = e.target.result;
                    localStorage.setItem('fontLibrary', JSON.stringify(fontLibrary));
                    document.getElementById(`preview-${escapeCharId(selectedChar)}`).innerHTML = 
                        `<img src="${e.target.result}" alt="${selectedChar}">`;
                    alert(`å­—ç¬¦${selectedChar}å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼`);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function resetCharImg() {
            if (confirm(`ç¡®å®šé‡ç½®å­—ç¬¦${selectedChar}å—ï¼Ÿ`)) {
                fontLibrary[currentVersion][selectedChar] = '';
                localStorage.setItem('fontLibrary', JSON.stringify(fontLibrary));
                document.getElementById(`preview-${escapeCharId(selectedChar)}`).textContent = 'ç©º';
            }
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function syncPreview() {
            // å¤åˆ¶è¾“å…¥åŒºå†…å®¹åˆ°é¢„è§ˆåŒº
            previewArea.innerHTML = testInput.innerHTML;
            
            // ç¡®ä¿é¢„è§ˆåŒºçš„å­—ç¬¦å…ƒç´ åº”ç”¨æœ€æ–°çš„é—´è·
            const previewChars = previewArea.querySelectorAll('.letter-img, .letter-text, .number-img, .number-text, .symbol-img, .symbol-text');
            
            previewChars.forEach(char => {
                // ä¼˜å…ˆåº”ç”¨å•ç‹¬é—´è·ï¼Œå¦åˆ™ç”¨å…¨å±€é—´è·
                if (char.classList.contains('custom-spacing')) {
                    const customVal = parseInt(char.style.marginRight) || customSpacing;
                    char.style.marginRight = `${customVal}px`;
                } else {
                    char.style.marginRight = `${letterSpacing}px`;
                }
            });
            
            // åŒæ­¥é€‰ä¸­çŠ¶æ€
            syncSelectionToPreview();
        }

        function setBrushColor(color) {
            brushColor = color;
            
            // åˆ‡æ¢é¢œè‰²æ—¶æ›´æ–°å·¥å…·æŒ‰é’®çŠ¶æ€
            toolButtons.forEach(btn => {
                if (btn.onclick.toString().includes(`setBrushColor('${color}')`)) {
                    btn.classList.add('active-tool');
                } else if (btn.onclick.toString().includes('setBrushColor')) {
                    btn.classList.remove('active-tool');
                }
            });

            // æ©¡çš®æ“¦ç‰¹æ®Šå¤„ç†
            if (color === 'white') {
                if (brushSize < 10) {
                    brushSize = 15;
                    document.querySelector('.brush-size-control input').value = brushSize;
                    document.getElementById('brushSizeValue').textContent = brushSize;
                }
                document.querySelector('.eraser-shape-group').style.display = 'flex';
            } else {
                setTool(currentTool);
                document.querySelector('.eraser-shape-group').style.display = 'none';
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                tempCtx.lineCap = 'round';
                tempCtx.lineJoin = 'round';
            }
        }

        function setBrushSize(size) {
            brushSize = parseInt(size);
            document.getElementById('brushSizeValue').textContent = size;
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
            initCanvasGridLines();
        }

        function addVersion() {
            const name = prompt('è¯·è¾“å…¥æ–°ç‰ˆæœ¬åç§°ï¼š', `è‡ªå®šä¹‰ç‰ˆæœ¬${Object.keys(fontLibrary).length}`);
            if (!name || fontLibrary[name]) {
                alert('ç‰ˆæœ¬åç§°ä¸èƒ½ä¸ºç©ºæˆ–å·²å­˜åœ¨ï¼');
                return;
            }
            fontLibrary[name] = JSON.parse(JSON.stringify(fontLibrary[currentVersion]));
            localStorage.setItem('fontLibrary', JSON.stringify(fontLibrary));
            initVersionSelector();
            alert(`ç‰ˆæœ¬ã€Œ${name}ã€åˆ›å»ºæˆåŠŸï¼`);
        }

        function deleteVersion() {
            if (Object.keys(fontLibrary).length <= 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªç‰ˆæœ¬ï¼');
                return;
            }
            if (currentVersion === 'åˆå§‹ç‰ˆ') {
                alert('åˆå§‹ç‰ˆæœ¬ä¸èƒ½åˆ é™¤ï¼');
                return;
            }
            if (confirm(`ç¡®å®šåˆ é™¤ç‰ˆæœ¬ã€Œ${currentVersion}ã€å—ï¼Ÿ`)) {
                delete fontLibrary[currentVersion];
                currentVersion = Object.keys(fontLibrary)[0];
                localStorage.setItem('fontLibrary', JSON.stringify(fontLibrary));
                initVersionSelector();
                initCharGrids();
            }
        }

        function exportFontLibrary() {
            const data = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(fontLibrary))}`;
            const a = document.createElement('a');
            a.href = data;
            a.download = `å­—ç¬¦åº“_${new Date().getTime()}.json`;
            a.click();
        }
    </script>
</body>
</html>